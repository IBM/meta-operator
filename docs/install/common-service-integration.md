<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Pre-Requisites](#pre-requisites)
  - [Test your operator bundle](#test-your-operator-bundle)
  - [Push the operator to quay.io](#push-the-operator-to-quayio)
  - [Test your operator standalone on the Openshift console](#test-your-operator-standalone-on-the-openshift-console)
    - [1. Create OperatorSource](#1-create-operatorsource)
    - [2. Create a Namespace for your operator](#2-create-a-namespace-for-your-operator)
    - [3. Install Operator](#3-install-operator)
- [Resolving services dependency](#resolving-services-dependency)
  - [How to share secret or configmap between services](#how-to-share-secret-or-configmap-between-services)
    - [Background](#background)
    - [As an information provider](#as-an-information-provider)
    - [As a information requester/adopter](#as-a-information-requesteradopter)
    - [One more thing](#one-more-thing)
- [Common Service Onboarding](#common-service-onboarding)
  - [1. Clone the git repository of operand deployment lifecycle manager](#1-clone-the-git-repository-of-operand-deployment-lifecycle-manager)
  - [2. Edit default value of custom resource](#2-edit-default-value-of-custom-resource)
    - [Edit the OperandRegistry custom resource](#edit-the-operandregistry-custom-resource)
    - [Edit the OperandConfig custom resource](#edit-the-operandconfig-custom-resource)
    - [Edit a OperandRequest custom resource](#edit-a-operandrequest-custom-resource)
    - [Edit alm-example in the operand-deployment-lifecycle-manager CSV](#edit-alm-example-in-the-operand-deployment-lifecycle-manager-csv)
  - [3.Make a pull request to merge the changes](#3make-a-pull-request-to-merge-the-changes)
- [End to end test](#end-to-end-test)
  - [1. Create an OperatorSource in the Openshift cluster](#1-create-an-operatorsource-in-the-openshift-cluster)
  - [2. Create a Namespace `ibm-common-services`](#2-create-a-namespace-ibm-common-services)
  - [3. Install operand deployment lifecycle manager](#3-install-operand-deployment-lifecycle-manager)
  - [4. Check the installed operators](#4-check-the-installed-operators)
  - [5. Edit the OperandConfig custom resource and the OperandRegistry custom resource](#5-edit-the-operandconfig-custom-resource-and-the-operandregistry-custom-resource)
  - [6. Create a OperandRequest](#6-create-a-operandrequest)
  - [7. Check the installed operators and their custom resource](#7-check-the-installed-operators-and-their-custom-resource)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# Pre-Requisites

## Test your operator bundle

- [operator-courier](https://github.com/operator-framework/operator-courier)
- [scorecard](https://github.com/operator-framework/operator-sdk/blob/master/doc/test-framework/scorecard.md)

**Note:** Follow this [How to push to Quay.io](https://github.com/operator-framework/community-operators/blob/master/docs/testing-operators.md#push-to-quayio) to push your operator bundle (including CSV, CRD and Package.yaml) to the Quay.io.

**Note:** The CSV generated by operator sdk is not a complete CSV. The following fields need to be added manually. You can get more informations from [generating-a-csv](https://github.com/operator-framework/operator-sdk/blob/master/doc/user/olm-catalog/generating-a-csv.md) and [csv-annotations](https://github.com/operator-framework/operator-sdk/blob/master/doc/user/olm-catalog/csv-annotations.md).

- `description`, `displayName`, `resources`, `specDescriptors`, `statusDescriptors`, `actionDescriptors` fields in each spec.customresourcedefinitions.owned element will not be filled by the CSV generator.

- `displayName` and `description` are necessary for the CSV.

- `spec.replaces`, `spec.links`, `spec.selector`, `spec.icon` and `spec.maturity` fields can't be generated as well, but they are optional and will not be overwritten by the operator-sdk generate command.

## Push the operator to quay.io

All common services OLMs and operator images should be published in public org in Quay.io: [OpenCloudio](https://quay.io/organization/opencloudio)

more information see the [push olm to quay.io](https://github.com/operator-framework/community-operators/blob/master/docs/testing-operators.md#push-to-quayio).

## Test your operator standalone on the Openshift console

### 1. Create OperatorSource

Open OCP console, click the `Plus` button on the top right and paste the following content, then click `Create`.

```yaml
apiVersion: operators.coreos.com/v1
kind: OperatorSource
metadata:
  name: opencloud-operators
  namespace: openshift-marketplace
spec:
  authorizationToken: {}
  displayName: IBMCS Operators
  endpoint: https://quay.io/cnr
  publisher: IBM
  registryNamespace: opencloudio
  type: appregistry
```

### 2. Create a Namespace for your operator

Open the `OperatorHub` page in OCP console left menu, then `Create Project`.

### 3. Install Operator

Open `OperatorHub`, search your operator and install it.

# Resolving services dependency

## How to share secret or configmap between services

This topic is for the services which need to share their `secret` or `configmap` to other services.

### Background

In Q1, all the common services will be installed into the same namespace.

The namespace is something like: `ibm-common-services`.

In the Q1 release, there is no dependency management from ODLM, all the required operators need to be added into `OperandRequest` instance.

In the Q2 release, operators will use `OperandRequest` to manage their own dependencies.

### As an information provider

Take MongoDB as an example:

MongoDB provides two secrets and a configmap to all the service accounts in the `ibm-common-services`.

The `deploy/role.yaml`:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  creationTimestamp: null
  name: ibm-mongodb-operator-info
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  resourceNames:
  - icp-mongodb-client-cert
  - icp-mongodb-admin
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - configmaps
  resourceNames:
  - icp-mongodb
  verbs:
  - get
```

The `deploy/role_binding.yaml`:

```yaml
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ibm-mongodb-operator-info
subjects:
- kind: Group
  name: system:serviceaccounts:ibm-common-services
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: ibm-mongodb-operator-info
  apiGroup: rbac.authorization.k8s.io
```

The above role/rolebinding means: IAM and Metering can get and mount the secret/configmap in their deployment/daemonset/statefulset.

### As a information requester/adopter

I need to know the information provider's secret/configmap name.

Take Metering as an example:

Metering needs to know the MongoDB secret and configmap:

- secret: icp-mongodb-client-cert, icp-mongodb-admin
- configmap: icp-mongodb

Metering needs to mount these configmap/secret to metering deployment/daemonset.

### One more thing

As we can see from above, the operators should appoint the service account name and the secret/configmap name to share info.

In the future releases, we will use Bindings and Requests to elegantly handle the information between operators.

# Common Service Onboarding

**Note:** Before onboard your operater to the operand deployment lifecycle manager, make sure your operater has finished the [pre-requisites](#pre-requisites), technically, can be deployed manually by OLM.

## 1. Clone the git repository of operand deployment lifecycle manager

```bash
git clone git@github.com:IBM/operand-deployment-lifecycle-manager.git
```

## 2. Edit default value of custom resource

### Edit the OperandRegistry custom resource

```bash
cd operand-deployment-lifecycle-manager
vi deploy/crds/operator.ibm.com_v1alpha1_operandregistry_cr.yaml
```

Append the operator package information under the `operators` field.

```yaml
apiVersion: operator.ibm.com/v1alpha1
kind: OperandRegistry
metadata:
name: common-service
spec:
operators:
...
- name: jenkins
    namespace: jenkins-operator
    channel: alpha
    packageName: jenkins-operator
    sourceName: community-operators
    sourceNamespace: openshift-marketplace
    description: The jenkins service depends on ...
...
```

- `name` is the name of the operator, which should be the same as the services name in the `OperandConfig` and `OperandRequest`.
- `namespace` is the namespace the operator will be deployed in. For the common services, they need to be installed in the `ibm-common-services` namespace.
- `channel` is the name of a tracked channel.
- `packageName` is the name of the package in `CatalogSource` will be deployed.
- `sourceName` is the name of the `CatalogSource`.
- `sourceNamespace` is the namespaces of the `CatalogSource`.
- `description` is used to add a detailed description for service including clarifying the dependency.

### Edit the OperandConfig custom resource

```bash
cd operand-deployment-lifecycle-manager
vi deploy/crds/operator.ibm.com_v1alpha1_operandconfig_cr.yaml
```

Append the operator custom resource information under the `services` field.

```yaml
apiVersion: operator.ibm.com/v1alpha1
kind: OperandConfig
metadata:
  name: common-service
spec:
  services:
  ...
  - name: jenkins
    spec:
      jenkins:
        service:
          port: 8081
  ...
```

Take the jenkins operator as an example.
- The `name` field defines the name of the operator.
- The `spec` field defines a map. Its key `jenkins` is the kind name of the custom resource. Its value `service.port: 8081` will be merged to the `spec` field of custom resource `jenkins`.

In this example:
The configuration for custom resource `Jenkins` is:

```yaml
      jenkins:
        service:
          port: 8081
```

The configuration will be merged in the `spec` of the relevant `alm-example` in the `cluster service version` and generate custom resource `Jenkins`

```yaml
apiVersion: jenkins.io/v1alpha2
kind: Jenkins
metadata:
  ...
  name: example
  namespace: jenkins-operator
spec:
  ...
  service:
    port: 8081
    type: ClusterIP
```

**Note:** When onboarding your operator, you need to put all the default configuration into the `alm-example`of your CSV and leave the value of map in `spec` to `{}`.
For example:

```yaml
apiVersion: operator.ibm.com/v1alpha1
kind: OperandConfig
metadata:
  name: common-service
spec:
  services:
  ...
  - name: jenkins
    spec:
      jenkins: {}
  ...
```

### Edit a OperandRequest custom resource

```bash
cd operand-deployment-lifecycle-manager
vi deploy/crds/operator.ibm.com_v1alpha1_operandrequest_cr.yaml
```

Append the operator information under the `services` field.

```yaml
apiVersion: operator.ibm.com/v1alpha1
kind: OperandRequest
metadata:
  name: common-service
spec:
  services:
  ...
  requests:
  - operands:
      - name: jenkins
    registry: common-service
    registryNamespace: ibm-common-services
  ...
```

- `services` is a list defines the set for each service.
- `name` is the service name, which should be the same as the services name in the `OperandConfig` and operator name in the `OperandRegistry`.
- `channel` is an optional setting, it can overwrite the `channel` defined in the `OperandRegistry`.
- `state` defines if the service should be present or absent.
- `description` is the description of the service.

### Edit alm-example in the operand-deployment-lifecycle-manager CSV

Add the changes for operandrequest operandregistry and operandconfig in the [alm-example](https://github.com/IBM/operand-deployment-lifecycle-manager/blob/master/deploy/olm-catalog/operand-deployment-lifecycle-manager/1.1.0/operand-deployment-lifecycle-manager.v1.1.0.clusterserviceversion.yaml#L5)

## 3.Make a pull request to merge the changes

# End to end test

**Note:** before running the e2e test, users have to push your own CSV package to Quay.io.
more information see [Push the operator to quay.io](#push-the-operator-to-quayio).

## 1. Create an OperatorSource in the Openshift cluster

Open OCP console, click the `Plus` button on the top right and paste the following content, then click `Create`.

```yaml
apiVersion: operators.coreos.com/v1
kind: OperatorSource
metadata:
  name: opencloud-operators
  namespace: openshift-marketplace
spec:
  authorizationToken: {}
  displayName: IBMCS Operators
  endpoint: https://quay.io/cnr
  publisher: IBM
  registryNamespace: opencloudio
  type: appregistry
```

## 2. Create a Namespace `ibm-common-services`

Open `OperatorHub` page in OCP console left menu, then `Create Project`, e.g., create a project named `ibm-common-services`.

## 3. Install operand deployment lifecycle manager

Open `OperatorHub` and search `operand-deployment-lifecycle-manager` to find the operator, and install it.

## 4. Check the installed operators

Open `Installed Operators` page to check the installed operators.

## 5. Edit the OperandConfig custom resource and the OperandRegistry custom resource

- [Editing OperandConfig](#edit-the-operandconfig-custom-resource)
- [Editing OperandRegistry](#edit-the-operandregistry-custom-resource)

## 6. Create a OperandRequest

```bash
vi deploy/crds/operator.ibm.com_v1alpha1_operandrequest_cr.yaml
oc apply -f deploy/crds/operator.ibm.com_v1alpha1_operandrequest_cr.yaml -n ibm-common-services
```

- [Editing OperandRequest](#edit-a-operandrequest-custom-resource)

## 7. Check the installed operators and their custom resource
